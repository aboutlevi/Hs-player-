<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur IPTV Pro</title>
    
    <!-- Bootstrap 5 Dark Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Video.js -->
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0d6efd;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
        }
        
        body {
            background: var(--dark-bg);
            color: #e2e8f0;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
        }
        
        /* Player container */
        .player-wrapper {
            width: 100%;
            height: 70vh;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        /* Info overlay */
        .channel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 10;
        }
        
        /* EPG sidebar */
        .epg-sidebar {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            height: 70vh;
            overflow-y: auto;
            display: none; /* Caché par défaut */
        }
        
        .epg-sidebar.active {
            display: block;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Programme EPG */
        .epg-program {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .epg-program.current {
            background: rgba(13, 110, 253, 0.15);
            border-left-color: var(--primary);
        }
        
        .epg-program:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Badges qualité */
        .badge-quality {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-hd { background: linear-gradient(135deg, #48dbfb, #0abde3); }
        .badge-fhd { background: linear-gradient(135deg, #1dd1a1, #10ac84); }
        .badge-4k { background: linear-gradient(135deg, #ff6b6b, #ee5a24); }
        .badge-live { background: linear-gradient(135deg, #ff9f43, #ee5253); }
        
        /* Controls bar */
        .controls-bar {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .player-wrapper, .epg-sidebar {
                height: 50vh;
            }
            .controls-bar {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Player Section -->
            <div class="col-lg-8 col-md-12 mb-4">
                <div class="player-wrapper">
                    <!-- Info overlay -->
                    <div class="channel-overlay">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 id="channelName" class="mb-1">Chargement...</h3>
                                <div class="d-flex gap-2 align-items-center">
                                    <span id="qualityBadge" class="badge-quality badge-hd">HD</span>
                                    <span id="liveBadge" class="badge-quality badge-live d-none">
                                        <i class="bi bi-circle-fill me-1"></i> LIVE
                                    </span>
                                    <small id="epgSource" class="text-muted">EPG: Chargement...</small>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-light" id="epgToggleBtn">
                                    <i class="bi bi-tv me-1"></i> Programme
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Player -->
                    <video id="video-player" class="video-js vjs-fluid" controls preload="auto">
                        <p class="vjs-no-js">JavaScript est requis pour ce lecteur.</p>
                    </video>
                </div>
                
                <!-- Controls -->
                <div class="controls-bar">
                    <div class="d-flex flex-wrap gap-3 justify-content-center align-items-center">
                        <button class="btn btn-outline-light" onclick="player.togglePlay()" id="playBtn">
                            <i class="bi bi-pause-fill"></i>
                        </button>
                        <button class="btn btn-outline-light" onclick="player.toggleMute()" id="muteBtn">
                            <i class="bi bi-volume-up-fill"></i>
                        </button>
                        <input type="range" class="form-range" style="width: 100px;" min="0" max="100" 
                               value="50" oninput="player.updateVolume(this.value)">
                        <button class="btn btn-outline-light" onclick="player.toggleFullscreen()">
                            <i class="bi bi-fullscreen"></i>
                        </button>
                        <select class="form-select form-select-sm bg-dark text-light" style="width: auto;" 
                                onchange="player.changeQuality(this.value)">
                            <option value="auto">Qualité Auto</option>
                            <option value="1080">1080p</option>
                            <option value="720">720p</option>
                            <option value="480">480p</option>
                        </select>
                        <button class="btn btn-outline-warning" onclick="player.reloadEPG()">
                            <i class="bi bi-arrow-clockwise"></i> Actualiser EPG
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- EPG Sidebar -->
            <div class="col-lg-4 col-md-12">
                <div class="epg-sidebar" id="epgSidebar">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="bi bi-tv me-2"></i>
                            <span id="epgChannelTitle">Programme TV</span>
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="player.changeEPGDate(-1)">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <span class="btn btn-sm btn-outline-secondary mx-2" id="epgDate">Aujourd'hui</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="player.changeEPGDate(1)">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="epgContent" class="mb-3">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Chargement du programme...</p>
                        </div>
                    </div>
                    
                    <div class="text-center small text-muted mt-3">
                        <i class="bi bi-info-circle me-1"></i>
                        <span id="epgStatus">Recherche des informations de programme...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script>
    class SimpleIPTVPlayer {
        constructor() {
            this.player = null;
            this.hls = null;
            this.currentChannel = null;
            this.epgData = null;
            this.currentEPGDate = new Date();
            this.epgVisible = false;
            
            // Sources EPG externes (priorité)
            this.epgSources = [
                'https://xmltv.fr/xmltv/xmltv-tnt.xml',
                'https://iptv-org.github.io/epg/guides/fr.xml',
                'https://raw.githubusercontent.com/iptv-org/epg/master/guides/fr.xml'
            ];
            
            this.init();
        }
        
        init() {
            this.setupPlayer();
            this.loadFromURL();
            this.setupControls();
        }
        
        setupPlayer() {
            this.player = videojs('video-player', {
                fluid: true,
                autoplay: true,
                controls: true,
                responsive: true,
                html5: {
                    vhs: {
                        overrideNative: true
                    }
                }
            });
            
            this.player.on('error', (e) => {
                console.error('Player error:', e);
                this.showError();
            });
            
            this.player.on('loadedmetadata', () => {
                this.updateQualityBadge();
            });
        }
        
        loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            
            // Support multiple URL formats
            let channelURL = params.get('src') || 
                            params.get('url') || 
                            this.extractFromChannelsParam(params.get('channels'));
            
            let channelName = params.get('name') || 'Chaîne IPTV';
            
            if (channelURL) {
                this.currentChannel = {
                    name: decodeURIComponent(channelName),
                    url: channelURL,
                    quality: this.detectQuality(channelURL)
                };
                
                this.updateUI();
                this.loadStream(channelURL);
                this.loadEPG(channelName);
            } else {
                document.getElementById('channelName').textContent = '⚠️ Aucune source';
                document.getElementById('channelName').innerHTML += 
                    '<br><small class="text-warning">Ajoutez ?src=URL à l\'URL</small>';
            }
        }
        
        extractFromChannelsParam(channelsParam) {
            if (!channelsParam) return null;
            try {
                const channels = JSON.parse(decodeURIComponent(channelsParam));
                if (channels && channels.length > 0) {
                    return channels[0].url;
                }
            } catch (e) {
                console.warn('Failed to parse channels param:', e);
            }
            return null;
        }
        
        detectQuality(url) {
            const urlLower = url.toLowerCase();
            if (urlLower.includes('4k') || urlLower.includes('2160')) return '4K';
            if (urlLower.includes('1080') || urlLower.includes('fhd')) return 'FHD';
            if (urlLower.includes('720') || urlLower.includes('hd')) return 'HD';
            return 'SD';
        }
        
        loadStream(url) {
            if (this.hls) {
                this.hls.destroy();
            }
            
            if (url.includes('.m3u8') && Hls.isSupported()) {
                this.hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true
                });
                
                this.hls.loadSource(url);
                this.hls.attachMedia(this.player.tech().el());
                
                this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    this.player.play();
                });
            } else {
                this.player.src({ src: url, type: 'video/mp4' });
                this.player.play();
            }
        }
        
        updateUI() {
            if (!this.currentChannel) return;
            
            // Mettre à jour le nom de la chaîne
            document.getElementById('channelName').textContent = this.currentChannel.name;
            
            // Mettre à jour le badge de qualité
            const badge = document.getElementById('qualityBadge');
            badge.textContent = this.currentChannel.quality;
            badge.className = 'badge-quality ';
            
            switch(this.currentChannel.quality) {
                case '4K': badge.classList.add('badge-4k'); break;
                case 'FHD': badge.classList.add('badge-fhd'); break;
                case 'HD': badge.classList.add('badge-hd'); break;
                default: badge.classList.add('badge-hd');
            }
            
            // Afficher "LIVE" pour les streams HLS
            if (this.currentChannel.url.includes('.m3u8')) {
                document.getElementById('liveBadge').classList.remove('d-none');
            }
        }
        
        updateQualityBadge() {
            if (!this.player) return;
            
            const height = this.player.videoHeight();
            const badge = document.getElementById('qualityBadge');
            
            if (height >= 2160) {
                badge.textContent = '4K';
                badge.className = 'badge-quality badge-4k';
            } else if (height >= 1080) {
                badge.textContent = 'FHD';
                badge.className = 'badge-quality badge-fhd';
            } else if (height >= 720) {
                badge.textContent = 'HD';
                badge.className = 'badge-quality badge-hd';
            }
        }
        
        async loadEPG(channelName) {
            try {
                document.getElementById('epgChannelTitle').textContent = channelName;
                document.getElementById('epgStatus').textContent = 'Recherche EPG...';
                
                // Essayer chaque source EPG
                for (const source of this.epgSources) {
                    const epgData = await this.fetchEPG(source, channelName);
                    if (epgData && epgData.length > 0) {
                        this.epgData = epgData;
                        this.displayEPG();
                        document.getElementById('epgSource').textContent = 'EPG: ' + 
                            source.split('/').slice(-2, -1)[0] || 'Source externe';
                        document.getElementById('epgStatus').textContent = 'EPG chargé avec succès';
                        return;
                    }
                }
                
                // Si aucune source ne fonctionne
                this.displayNoEPG();
                
            } catch (error) {
                console.error('EPG Error:', error);
                this.displayNoEPG();
            }
        }
        
        async fetchEPG(sourceUrl, channelName) {
            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(sourceUrl)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                // Parser le XML
                return this.parseEPGXML(data.contents, channelName);
                
            } catch (error) {
                console.warn('EPG source failed:', sourceUrl, error);
                return null;
            }
        }
        
        parseEPGXML(xmlContent, channelName) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
            const programmes = [];
            const channelSearch = channelName.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            // Chercher la chaîne et ses programmes
            const programmeNodes = xmlDoc.getElementsByTagName('programme');
            
            for (let prog of programmeNodes) {
                const titleElem = prog.getElementsByTagName('title')[0];
                const descElem = prog.getElementsByTagName('desc')[0];
                const start = prog.getAttribute('start');
                
                if (titleElem && start) {
                    const title = titleElem.textContent;
                    const desc = descElem ? descElem.textContent : '';
                    
                    // Parser la date XMLTV (YYYYMMDDHHMMSS +0000)
                    const year = start.substring(0, 4);
                    const month = start.substring(4, 6) - 1;
                    const day = start.substring(6, 8);
                    const hour = start.substring(8, 10);
                    const minute = start.substring(10, 12);
                    
                    const startTime = new Date(year, month, day, hour, minute);
                    
                    programmes.push({
                        start: startTime,
                        title: title,
                        description: desc,
                        duration: '60 min' // Approximation
                    });
                }
            }
            
            // Trier par heure et limiter à 10 programmes
            programmes.sort((a, b) => a.start - b.start);
            return programmes.slice(0, 10);
        }
        
        displayEPG() {
            if (!this.epgData || this.epgData.length === 0) {
                this.displayNoEPG();
                return;
            }
            
            const now = new Date();
            let html = '';
            
            this.epgData.forEach(prog => {
                const isCurrent = now >= prog.start && now < new Date(prog.start.getTime() + 60*60000);
                
                html += `
                    <div class="epg-program ${isCurrent ? 'current' : ''}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="small text-muted">
                                    ${prog.start.getHours().toString().padStart(2, '0')}:${prog.start.getMinutes().toString().padStart(2, '0')}
                                    • ${prog.duration}
                                </div>
                                <div class="fw-bold mt-1">${prog.title}</div>
                            </div>
                            ${isCurrent ? '<span class="badge bg-danger">EN COURS</span>' : ''}
                        </div>
                        ${prog.description ? `<div class="small mt-2">${prog.description.substring(0, 100)}...</div>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('epgContent').innerHTML = html;
            
            // Mettre à jour la date affichée
            const dateStr = this.currentEPGDate.toLocaleDateString('fr-FR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
            document.getElementById('epgDate').textContent = dateStr;
        }
        
        displayNoEPG() {
            const html = `
                <div class="text-center py-5">
                    <i class="bi bi-tv display-4 text-muted mb-3"></i>
                    <h5>Programme non disponible</h5>
                    <p class="text-muted">L'EPG sera mis à jour automatiquement</p>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="player.loadEPG(player.currentChannel.name)">
                        <i class="bi bi-arrow-clockwise me-1"></i> Réessayer
                    </button>
                </div>
            `;
            
            document.getElementById('epgContent').innerHTML = html;
            document.getElementById('epgStatus').textContent = 'EPG: Information non disponible';
            document.getElementById('epgSource').textContent = 'EPG: Aucune source';
        }
        
        toggleEPG() {
            this.epgVisible = !this.epgVisible;
            const sidebar = document.getElementById('epgSidebar');
            const button = document.getElementById('epgToggleBtn');
            
            if (this.epgVisible) {
                sidebar.classList.add('active');
                button.classList.add('active', 'btn-primary');
                button.classList.remove('btn-outline-light');
                
                // S'assurer que l'EPG est chargé
                if (!this.epgData && this.currentChannel) {
                    this.loadEPG(this.currentChannel.name);
                }
            } else {
                sidebar.classList.remove('active');
                button.classList.remove('active', 'btn-primary');
                button.classList.add('btn-outline-light');
            }
        }
        
        reloadEPG() {
            if (this.currentChannel) {
                this.loadEPG(this.currentChannel.name);
            }
        }
        
        changeEPGDate(days) {
            this.currentEPGDate.setDate(this.currentEPGDate.getDate() + days);
            if (this.epgData) {
                this.displayEPG();
            }
        }
        
        togglePlay() {
            if (this.player.paused()) {
                this.player.play();
                document.getElementById('playBtn').innerHTML = '<i class="bi bi-pause-fill"></i>';
            } else {
                this.player.pause();
                document.getElementById('playBtn').innerHTML = '<i class="bi bi-play-fill"></i>';
            }
        }
        
        toggleMute() {
            this.player.muted(!this.player.muted());
            const icon = this.player.muted() ? 'volume-mute' : 'volume-up';
            document.getElementById('muteBtn').innerHTML = `<i class="bi bi-${icon}-fill"></i>`;
        }
        
        toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        changeQuality(quality) {
            if (this.hls && quality !== 'auto') {
                const levels = this.hls.levels;
                if (levels) {
                    const height = parseInt(quality);
                    const level = levels.find(l => l.height >= height);
                    if (level) {
                        this.hls.currentLevel = level.levelId;
                    }
                }
            }
        }
        
        updateVolume(value) {
            this.player.volume(value / 100);
        }
        
        showError() {
            // Simple error display
            document.getElementById('channelName').innerHTML += 
                '<br><small class="text-danger">Erreur de chargement</small>';
        }
        
        setupControls() {
            // Raccourcis clavier
            document.addEventListener('keydown', (e) => {
                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        this.togglePlay();
                        break;
                    case 'KeyE':
                        this.toggleEPG();
                        break;
                    case 'KeyF':
                        this.toggleFullscreen();
                        break;
                    case 'Escape':
                        if (this.epgVisible) this.toggleEPG();
                        break;
                }
            });
            
            // Bouton EPG toggle
            document.getElementById('epgToggleBtn').addEventListener('click', () => {
                this.toggleEPG();
            });
            
            // Auto-hide EPG on mobile
            if (window.innerWidth < 768) {
                this.epgVisible = false;
                document.getElementById('epgSidebar').classList.remove('active');
            }
        }
    }
    
    // Initialiser le lecteur
    let player = null;
    document.addEventListener('DOMContentLoaded', () => {
        player = new SimpleIPTVPlayer();
    });
    </script>
</body>
                                </html>
