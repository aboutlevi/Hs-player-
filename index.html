<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° IPTV Pro</title>
    
    <!-- Bootstrap minimal -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Video.js -->
    <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #667eea;
            --dark-bg: #0f172a;
        }
        
        body {
            background: var(--dark-bg);
            font-family: 'Segoe UI', sans-serif;
            color: #fff;
            margin: 0;
            padding: 0;
        }
        
        /* Navbar simple */
        .navbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 10px 0;
        }
        
        /* Player */
        .player-wrapper {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            background: #000;
        }
        
        /* Nom de la cha√Æne - effet gradient */
        .channel-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            line-height: 1.2;
        }
        
        /* Programme en cours */
        .now-playing {
            color: #10b981;
            font-weight: 500;
            font-size: 1rem;
        }
        
        /* EPG */
        .epg-container {
            background: rgba(30, 41, 59, 0.4);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            height: fit-content;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .epg-item {
            padding: 12px 16px;
            border-left: 4px solid transparent;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        
        .epg-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: var(--primary);
        }
        
        .epg-item.playing {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
        }
        
        .epg-time {
            color: #94a3b8;
            font-size: 0.85rem;
            min-width: 70px;
        }
        
        .epg-title {
            font-weight: 600;
            color: #fff;
        }
        
        /* Scrollbar */
        .epg-container::-webkit-scrollbar {
            width: 4px;
        }
        
        .epg-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        /* Statut */
        .status-badge {
            font-size: 0.9rem;
        }
        
        /* Aucun √©l√©ment superflu */
        .badge, .card, .modal, .list-group, .stream-info {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Navbar ultra minimaliste -->
    <nav class="navbar">
        <div class="container">
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle p-2 me-2" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <i class="bi bi-play-circle-fill fs-4 text-white"></i>
                </div>
                <span class="fw-bold fs-4" style="background: linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">IPTV Pro</span>
            </div>
            <div>
                <span id="statusIndicator" class="status-badge text-success">
                    <i class="bi bi-circle-fill me-1" style="font-size: 0.7rem;"></i> Pr√™t
                </span>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <div class="container-fluid px-4 py-4">
        <div class="row g-4">
            <!-- COLONNE PLAYER (70%) -->
            <div class="col-lg-7 col-xl-8">
                <div class="player-wrapper">
                    <video id="videoPlayer" class="video-js vjs-fluid vjs-big-play-centered" controls autoplay preload="auto">
                        <p class="vjs-no-js">JavaScript requis</p>
                    </video>
                </div>
                
                <!-- INFOS CHA√éNE - UNIQUEMENT √ßa -->
                <div class="d-flex justify-content-between align-items-start mt-3">
                    <div>
                        <h1 class="channel-title" id="channelNameDisplay">Cha√Æne IPTV</h1>
                        <div class="now-playing mt-1">
                            <i class="bi bi-broadcast me-1"></i>
                            <span id="currentEpgProgram">Chargement EPG...</span>
                        </div>
                    </div>
                    <button class="btn btn-outline-light btn-sm rounded-pill px-3" onclick="goFullscreen()">
                        <i class="bi bi-arrows-fullscreen me-1"></i> Plein √©cran
                    </button>
                </div>
            </div>
            
            <!-- COLONNE EPG (30%) - UNIQUEMENT EPG -->
            <div class="col-lg-5 col-xl-4">
                <div class="epg-container">
                    <h5 class="fw-bold mb-3 d-flex align-items-center">
                        <i class="bi bi-tv me-2" style="color: #667eea;"></i> 
                        Programme TV
                    </h5>
                    
                    <div id="epgList">
                        <div class="text-center py-5">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                            <span class="text-muted">R√©cup√©ration du guide...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        (function() {
            "use strict";

            // --------------------------------------------------------
            // 1. R√âCUP√âRATION DU FLUX DEPUIS L'URL (FORMAT BOT)
            // --------------------------------------------------------
            const urlParams = new URLSearchParams(window.location.search);
            
            let streamUrl = null;
            let channelName = "Cha√Æne IPTV";
            let channelLogo = null;
            let channelQuality = "HD";

            // PRIORIT√â 1 : Format "channels=[{...}]" (CELUI DU BOT)
            try {
                const channelsParam = urlParams.get('channels');
                if (channelsParam) {
                    const decoded = decodeURIComponent(channelsParam);
                    const channels = JSON.parse(decoded);
                    
                    if (Array.isArray(channels) && channels.length > 0) {
                        const channel = channels[0];
                        streamUrl = channel.url || null;
                        channelName = channel.name || channelName;
                        channelLogo = channel.logo || null;
                        channelQuality = channel.quality || "HD";
                        
                        console.log("‚úÖ Format BOT d√©tect√© (channels)");
                    }
                }
            } catch(e) {
                console.log("‚ùå Erreur parsing channels:", e);
            }

            // PRIORIT√â 2 : Format "url=..." et "name=..."
            if (!streamUrl) {
                streamUrl = urlParams.get('url');
                channelName = urlParams.get('name') || channelName;
                if (streamUrl) console.log("‚úÖ Format URL standard d√©tect√©");
            }

            // --------------------------------------------------------
            // 2. NETTOYAGE DE L'URL
            // --------------------------------------------------------
            if (streamUrl) {
                streamUrl = streamUrl.replace(/['"]+/g, '').trim();
                console.log("üì° URL du flux:", streamUrl);
            } else {
                console.error("‚ùå Aucun flux trouv√© dans l'URL");
                document.body.innerHTML = `
                    <div class="container vh-100 d-flex align-items-center justify-content-center">
                        <div class="text-center p-5" style="background:rgba(30,41,59,0.5); border-radius:20px;">
                            <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
                            <h3>Aucun flux sp√©cifi√©</h3>
                            <p class="text-muted">Utilisez ?channels=[{"url":"votre_flux.m3u8"}]</p>
                        </div>
                    </div>
                `;
                return; // Stop ici
            }

            // --------------------------------------------------------
            // 3. INITIALISATION DU LECTEUR
            // --------------------------------------------------------
            const player = videojs('videoPlayer', {
                controls: true,
                autoplay: true,
                preload: 'auto',
                fluid: true,
                responsive: true,
                playbackRates: [0.5, 1, 1.25, 1.5, 2],
                html5: {
                    hlsjsConfig: {
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 60,
                        maxBufferLength: 30,
                        xhrSetup: function(xhr, url) {
                            // Contournement pour flux prot√©g√©s
                            xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
                            xhr.setRequestHeader('Referer', window.location.origin + '/');
                            xhr.setRequestHeader('Origin', window.location.origin);
                        }
                    }
                }
            });

            // Afficher le nom de la cha√Æne
            document.getElementById('channelNameDisplay').textContent = channelName;

            // --------------------------------------------------------
            // 4. CHARGEMENT DU FLUX HLS
            // --------------------------------------------------------
            let hls = null;

            function loadStream(url) {
                if (!url) return;

                // D√©truire l'ancien HLS
                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                // V√©rifier support HLS
                if (Hls.isSupported()) {
                    hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 60,
                        xhrSetup: function(xhr, url) {
                            xhr.setRequestHeader('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36');
                            xhr.setRequestHeader('Referer', 'https://aboutlevi.github.io/');
                            xhr.setRequestHeader('Origin', 'https://aboutlevi.github.io');
                        }
                    });

                    hls.loadSource(url);
                    hls.attachMedia(player.tech().el());

                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        player.play();
                        document.getElementById('statusIndicator').innerHTML = '<i class="bi bi-circle-fill me-1 text-success"></i> Lecture';
                    });

                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS Error:', data);
                        
                        if (data.response && data.response.code === 403) {
                            document.getElementById('statusIndicator').innerHTML = '<i class="bi bi-exclamation-triangle me-1 text-warning"></i> Flux prot√©g√© (403)';
                        }
                    });

                } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari
                    player.src({ src: url, type: 'application/x-mpegURL' });
                    player.play();
                    document.getElementById('statusIndicator').innerHTML = '<i class="bi bi-circle-fill me-1 text-success"></i> Lecture (Safari)';
                } else {
                    player.src({ src: url, type: 'video/mp4' });
                    player.play();
                }
            }

            // Lancer le chargement
            loadStream(streamUrl);

            // --------------------------------------------------------
            // 5. EPG - iptv-org.github.io
            // --------------------------------------------------------
            async function fetchEPG() {
                const epgUrl = "https://iptv-org.github.io/epg/guides/fr.xml";
                const proxies = [
                    (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                    (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`
                ];

                for (let proxy of proxies) {
                    try {
                        const response = await fetch(proxy(epgUrl));
                        if (response.ok) {
                            const xmlText = await response.text();
                            return xmlText;
                        }
                    } catch(e) {
                        console.log("Proxy √©chou√©, essai suivant...");
                    }
                }
                throw new Error("EPG inaccessible");
            }

            async function loadEPG() {
                try {
                    const xmlText = await fetchEPG();
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(xmlText, "text/xml");

                    // Chercher l'ID de la cha√Æne
                    const channels = xml.querySelectorAll("channel");
                    let channelId = null;

                    for (let ch of channels) {
                        const name = ch.querySelector("display-name")?.textContent || "";
                        if (name.toLowerCase().includes(channelName.toLowerCase())) {
                            channelId = ch.getAttribute("id");
                            break;
                        }
                    }

                    if (!channelId) {
                        document.getElementById('epgList').innerHTML = '<div class="text-center py-4 text-muted">üì∫ EPG non disponible pour cette cha√Æne</div>';
                        return;
                    }

                    // R√©cup√©rer les programmes
                    const programs = xml.querySelectorAll("programme");
                    const epgItems = [];

                    programs.forEach(prog => {
                        if (prog.getAttribute("channel") === channelId) {
                            const start = prog.getAttribute("start");
                            const stop = prog.getAttribute("stop");
                            const title = prog.querySelector("title")?.textContent || "Sans titre";
                            const desc = prog.querySelector("desc")?.textContent || "";

                            // Format heure
                            let startTime = start;
                            if (start && start.length >= 12) {
                                startTime = start.substring(8, 10) + ":" + start.substring(10, 12);
                            }

                            // V√©rifier si c'est maintenant
                            const now = new Date();
                            const startDate = parseEPGDate(start);
                            const stopDate = parseEPGDate(stop);
                            const isNow = (now >= startDate && now <= stopDate);

                            epgItems.push({
                                start: startTime,
                                title: title,
                                desc: desc,
                                isNow: isNow
                            });
                        }
                    });

                    // Trier par heure
                    epgItems.sort((a, b) => a.start.localeCompare(b.start));
                    
                    // Afficher
                    displayEPG(epgItems);
                    
                    // Programme en cours
                    const current = epgItems.find(p => p.isNow);
                    if (current) {
                        document.getElementById('currentEpgProgram').innerHTML = `<i class="bi bi-play-circle-fill me-1"></i> ${current.title}`;
                    } else {
                        document.getElementById('currentEpgProgram').innerHTML = '<span class="text-muted">Aucun programme</span>';
                    }

                } catch(error) {
                    console.error("Erreur EPG:", error);
                    document.getElementById('epgList').innerHTML = '<div class="text-center py-4 text-muted"><i class="bi bi-wifi-off me-2"></i>EPG temporairement indisponible</div>';
                }
            }

            function parseEPGDate(epgTime) {
                if (!epgTime || epgTime.length < 14) return new Date();
                try {
                    const year = epgTime.substring(0, 4);
                    const month = epgTime.substring(4, 6);
                    const day = epgTime.substring(6, 8);
                    const hour = epgTime.substring(8, 10);
                    const minute = epgTime.substring(10, 12);
                    return new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
                } catch(e) {
                    return new Date();
                }
            }

            function displayEPG(items) {
                const container = document.getElementById('epgList');
                
                if (!items || items.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-muted">üì≠ Aucun programme trouv√©</div>';
                    return;
                }

                let html = '';
                items.slice(0, 20).forEach((item, index) => {
                    const activeClass = item.isNow ? 'playing' : '';
                    html += `
                        <div class="epg-item ${activeClass}">
                            <div class="d-flex">
                                <div class="epg-time">${item.start}</div>
                                <div>
                                    <div class="epg-title">${item.title}</div>
                                    ${item.desc ? `<small class="text-muted">${item.desc.substring(0, 60)}...</small>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            // Lancer l'EPG
            loadEPG();
            setInterval(loadEPG, 300000); // Rafra√Æchir toutes les 5 minutes

            // --------------------------------------------------------
            // 6. FONCTIONS UTILES
            // --------------------------------------------------------
            window.goFullscreen = function() {
                if (!document.fullscreenElement) {
                    player.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            };

            // Rechargement si besoin
            window.reloadStream = function() {
                if (streamUrl) loadStream(streamUrl);
            };

        })();
    </script>
</body>
                    </html>
